#import ScanVulns from libs/scan_vulns.gs;
#import Exploit from libs/exploit_class.gs;

knownVulns = {
  "1.2.6": [
    {"__isa": Exploit, "name": "eatebuttoncli", "comment": "Permission: Guest", "address": "0xBECDE25", "hasRequirement": 0}
  ],
  "2.0.5": [
    {"__isa": Exploit, "name": "etobjectot", "comment": "", "address": "0x4DC251D1", "hasRequirement": 1, "requirements": ["Using namespace net"]}
  ],
  "2.3.5": [
    {"__isa": Exploit, "name": "spritextsremove", "comment": "", "address": "0x49A623C7", "hasRequirement": 0}
  ],
  "2.6.8": [
    {"__isa": Exploit, "name": "++scan_tree", "comment": "Permission: root", "address": "0x6986497B", "hasRequirement": 0}
  ],
  "3.1.5": [
    {"__isa": Exploit, "name": "_ltreeint", "comment": "Permission: root", "address": "0x63F34EE8", "hasRequirement": 0}
  ],
  "3.3.1": [
    {"__isa": Exploit, "name": "ecolor_viewporttextpartcoundo", "comment": "Permission: Guest", "address": "0x4EC95BAF", "hasRequirement": 0}
  ],
  "3.7.6": [
    {"__isa": Exploit, "name": "andb", "comment": "Permission: Guest", "address": "0x423F61A1", "hasRequirement": 0}
  ],
  "3.7.9": [
    {"__isa": Exploit, "name": "yte", "comment": "Permission: Guest", "address": "0x1E82C304", "hasRequirement": 0}
  ],
  "4.0.6": [
    {"__isa": Exploit, "name": "paractioncl", "comment": "Permission: Guest", "address": "0x3E29FA62", "hasRequirement": 0}
  ],
  "4.2.6": [
    {"__isa": Exploit, "name": "ansformanchoredpositionstr", "comment": "Permission: Guest", "address": "0x72976157", "hasRequirement": 0}
  ],
  "4.3.2": [
    {"__isa": Exploit, "name": "andal", "comment": "Permission: Guest", "address": "0x659811FC", "hasRequirement": 0}
  ],
  "5.6.2": [
    {"__isa": Exploit, "name": "esulttypel", "comment": "", "address": "0x573CD2B2", "hasRequirement": 0}
  ],
  "5.7.1": [
    {"__isa": Exploit, "name": "tree", "comment": "Permission: Guest", "address": "0x10DFFC71", "hasRequirement": 0}
  ],
  "5.8.3": [
    {"__isa": Exploit, "name": "licid", "comment": "Permission: Guest", "address": "0x72F1AFF9", "hasRequirement": 0}
  ],
  "6.0.5": [
    {"__isa": Exploit, "name": "soundoseintostat", "comment": "Permission: Guest", "address": "0x2A863BFE", "hasRequirement": 0},
    {"__isa": Exploit, "name": "alse", "comment": "Permission: Guest", "address": "0x2A863BFE", "hasRequirement": 0},
    {"__isa": Exploit, "name": "sourcelintex", "comment": "Permission: Guest", "address": "0x663496EF", "hasRequirement": 0},
    {"__isa": Exploit, "name": "isrhsbui", "comment": "", "address": "0x663496EF", "hasRequirement": 0},
    {"__isa": Exploit, "name": "yuitextefunctivefaultselect", "comment": "", "address": "0x663496EF", "hasRequirement": 0}
  ]
}

metax = include_lib("/lib/metaxploit.so")
if not metax then 
  metax = include_lib(current_path + "/metaxploit.so")
end if

if not metax then 
  exit("Error: Missing metaxploit library")
end if

if params.len != 1 or params[0] == "-h" or params[0] == "--help" then exit("<b>Usage: exploitRouterShell [ip address]</b>")

routerIP = params[0]
routerNetSession = metax.net_use(routerIP, 0)
kernel_router = routerNetSession.dump_lib

exploitToUse = null
scanForNewVuln = false

print(kernel_router.lib_name+": "+kernel_router.version)

print("Checking existing vulns")

if (knownVulns.hasIndex(kernel_router.version)) then
  print("Known vulns: ")
  print("0. Scan for a different vuln")
  for exploitIndex in knownVulns[kernel_router.version].indexes()
    exploit = knownVulns[kernel_router.version][exploitIndex]
    print((exploitIndex+1)+". Address: "+exploit.address+" Name: "+exploit.name+ " Comment: "+exploit.comment)
    if (exploit.hasRequirement == true) then
      print("  Requirements: ")
      for r in exploit.requirements.indexes()
        print("    * "+exploit.requirements[r]+".")
      end for
    end if
  end for

  vulnIndex = user_input("Select Vuln to use: ").to_int()
  if (vulnIndex == 0) then
    scanForNewVuln = true
  else 
    exploitToUse = knownVulns[kernel_router.version][vulnIndex-1]
  end if
else
  print("No known vulns, scanning...")
end if

if (exploitToUse == null) then
  exploits = ScanVulns(kernel_router)
  for exploit in exploits

    if (scanForNewVuln) then
      foundSameVuln = false
      for exploitIndex in knownVulns[kernel_router.version].indexes()
        existingExploit = knownVulns[kernel_router.version][exploitIndex]
        if (existingExploit.address == exploit.address) then
          if (existingExploit.name == exploit.name) then
            foundSameVuln = true
            break
          end if
        end if
      end for

      if (foundSameVuln) then
        print("Skipping known exploit Address: "+exploit.address+" Name: "+exploit.name)
        continue
      end if
    end if

    if (exploit.hasRequirement == true) then
      print("Skipping exploit that has requirement...")
      continue
    end if

    overflow = kernel_router.overflow(exploit.address, exploit.name)
    if (typeof(overflow) != "shell") then
      print("Skipping non-shell exploit...")
      continue
    end if

    print("Found new exploit: "+exploit)
    exploitToUse = exploit
    break

  end for
end if

if (exploitToUse == null) then
  exit("No shell exploits found")
end if

overflow = kernel_router.overflow(exploitToUse.address, exploitToUse.name)
if (overflow == null) then
  exit("Exploit doesn't exist? Why did we have an invalid exploit")
end if

if (typeof(overflow) != "shell") then
  exit("Exploit is not a shell? Why did we have an non-shell exploit")
end if

print("Starting terminal shell")
overflow.start_terminal()
exit()
