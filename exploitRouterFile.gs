#import ScanVulns from libs/scan_vulns.gs;
#import Exploit from libs/exploit_class.gs;

knownVulns = {
  "2.3.5": [
    {"__isa": Exploit, "name": "opyp", "comment": "", "address": "0x49A623C7", "hasRequirement": 0}
  ],
  "2.4.0": [
    {"__isa": Exploit, "name": "re", "comment": "Permission: Guest", "address": "0x71E311BD", "hasRequirement": 0}
  ],
  "3.1.5": [
    {"__isa": Exploit, "name": "itlessedt", "comment": "Permission: Guest", "address": "0x2073DBF5", "hasRequirement": 0}
  ],
  "3.7.6": [
    {"__isa": Exploit, "name": "ontextu", "comment": "Permission: Guest", "address": "0x129B61BF", "hasRequirement": 0}
  ],
  "4.0.6": [
    {"__isa": Exploit, "name": "tebuttonbutto", "comment": "Permission: Guest", "address": "0x3E29FA62", "hasRequirement": 0}
  ],
  "4.2.6": [
    {"__isa": Exploit, "name": "glow", "comment": "Permission: Guest", "address": "0x72976157", "hasRequirement": 0},
    {"__isa": Exploit, "name": "ourcelinesremove", "comment": "Permission: Guest", "address": "0x1E098FC1", "hasRequirement": 0},
    {"__isa": Exploit, "name": "fast", "comment": "Permission: Non-root user", "address": "0x70A59318", "hasRequirement": 0}
  ],
  "5.0.3": [
    {"__isa": Exploit, "name": "endpointln", "comment": "Permission: Non-root user", "address": "0x71064F92", "hasRequirement": 0}
  ],
  "5.6.2": [
    
  ]
}

metax = include_lib("/lib/metaxploit.so")
if not metax then 
  metax = include_lib(current_path + "/metaxploit.so")
end if

if not metax then 
  exit("Error: Missing metaxploit library")
end if

if params.len != 1 or params[0] == "-h" or params[0] == "--help" then exit("<b>Usage: exploitRouterFile [ip address]</b>")

routerIP = params[0]
routerNetSession = metax.net_use(routerIP, 0)
kernel_router = routerNetSession.dump_lib

exploitToUse = null
scanForNewVuln = false

print(kernel_router.lib_name+": "+kernel_router.version)

print("Checking existing vulns")

if (knownVulns.hasIndex(kernel_router.version)) then
  print("Known vulns: ")
  print("0. Scan for a different vuln")
  for exploitIndex in knownVulns[kernel_router.version].indexes()
    exploit = knownVulns[kernel_router.version][exploitIndex]
    print((exploitIndex+1)+". Address: "+exploit.address+" Name: "+exploit.name+ " Comment: "+exploit.comment)
    if (exploit.hasRequirement == true) then
      print("  Requirements: ")
      for r in exploit.requirements.indexes()
        print("    * "+exploit.requirements[r]+".")
      end for
    end if
  end for

  vulnIndex = user_input("Select Vuln to use: ").to_int()
  if (vulnIndex == 0) then
    scanForNewVuln = true
  else 
    exploitToUse = knownVulns[kernel_router.version][vulnIndex-1]
  end if
else
  print("No known vulns, scanning...")
end if

lanAddress = user_input("Enter a LAN address: ")

if (exploitToUse == null) then
  exploits = ScanVulns(kernel_router)
  for exploit in exploits

    if (scanForNewVuln) then
      foundSameVuln = false
      for exploitIndex in knownVulns[kernel_router.version].indexes()
        existingExploit = knownVulns[kernel_router.version][exploitIndex]
        if (existingExploit.address == exploit.address) then
          if (existingExploit.name == exploit.name) then
            foundSameVuln = true
            break
          end if
        end if
      end for

      if (foundSameVuln) then
        print("Skipping known exploit Address: "+exploit.address+" Name: "+exploit.name)
        continue
      end if
    end if

    if (exploit.hasRequirement == true) then
      print("Exploit has the following requirements: ")
      for r in exploit.requirements.indexes()
        print("  * "+exploit.requirements[r]+".")
      end for
      
      tryExploit = user_input("Try exploit? [N/y]: ")
      if (tryExploit != "y") then
        continue
      end if
    end if

    overflow = kernel_router.overflow(exploit.address, exploit.name, lanAddress)
    if (typeof(overflow) != "computer") then
      print("Skipping non-computer exploit...")
      continue
    end if

    print("Found new exploit: "+exploit)
    exploitToUse = exploit
    break

  end for
end if

if (exploitToUse == null) then
  exit("No computer exploits found")
end if

overflow = kernel_router.overflow(exploitToUse.address, exploitToUse.name, lanAddress)
if (overflow == null) then
  exit("Exploit doesn't exist? Why did we have an invalid exploit")
end if

if (typeof(overflow) != "computer") then
  exit("Exploit is not a computer? Why did we have an non-computer exploit")
end if

filePath = user_input("Enter file path to view: ")
file = overflow.File(filePath)
if (file == null) then
  exit("File at path "+filePath+" does not exist")
end if

if (file.is_folder()) then
  print("File is folder, printing out directory listing: ")
  directoryListing = ""
  for folderIndex in file.get_folders().indexes()
    folder = file.get_folders()[folderIndex]
    directoryListing += folder.permissions()+"  "+folder.owner()+"  "+folder.group()+"  "+folder.size()+" 00:00 "+folder.name()+"\n"
  end for

  for fileIndex in file.get_files().indexes()
    f = file.get_files()[fileIndex]
    directoryListing += f.permissions()+"  "+f.owner()+"  "+f.group()+"  "+f.size()+" 00:00 "+f.name()+"\n"
  end for
  print(format_columns(directoryListing))

else if (file.is_binary()) then
  print("File is binary, cant do anything with it")

else if (file.get_content() != null) then
  print("File content is bellow:")
  print(file.get_content())

else
  print("No access to the file")
end if

exit()
