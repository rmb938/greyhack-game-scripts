#import ScanVulns from libs/scan_vulns.gs;
#import Exploit from libs/exploit_class.gs;

knownVulns = {
  "1.0.6": [
    {"__isa": Exploit, "name": "formanceoffsetvalues", "comment": "Permission: Non root user", "address": "0x5F6102CB", "hasRequirement": 0}
  ],
  "1.1.0": [
    {"__isa": Exploit, "name": "ontenercolor", "comment": "Permission: non-root user", "address": "0x5F3BF993", "hasRequirement": 1, "requirements": ["2 port forwarding configured from router to the target computer"]}
  ],
  "1.2.8": [
    {"__isa": Exploit, "name": "ontener", "comment": "Permission: guest", "address": "0x6CDB0CFC", "hasRequirement": 0}
  ],
  "1.5.7": [
    {"__isa": Exploit, "name": "texttexttextartposi", "comment": "Permission: Non root user", "address": "0x386BE5C6", "hasRequirement": 0},
    {"__isa": Exploit, "name": "ansformin", "comment": "Permission: root", "address": "0x386BE5C6", "hasRequirement": 0}
  ],
  "2.0.9": [
    {"__isa": Exploit, "name": "bool", "comment": "", "address": "0x5CA63288", "hasRequirement": 1, "requirements": ["Checking an active user"]}
  ]
}

metax = include_lib("/lib/metaxploit.so")
if not metax then 
  metax = include_lib(current_path + "/metaxploit.so")
end if

if not metax then 
  exit("Error: Missing metaxploit library")
end if

if params.len != 1 or params[0] == "-h" or params[0] == "--help" then exit("<b>Usage: exploitSSHFile [ip address]</b>")

sshIP = params[0]
sshNetSession = metax.net_use(sshIP, 22)
libSSH = sshNetSession.dump_lib

exploitToUse = null
scanForNewVuln = false

print(libSSH.lib_name+": "+libSSH.version)

print("Checking existing vulns")

if (knownVulns.hasIndex(libSSH.version)) then
  print("Known vulns: ")
  print("0. Scan for a different vuln")
  for exploitIndex in knownVulns[libSSH.version].indexes()
    exploit = knownVulns[libSSH.version][exploitIndex]
    print((exploitIndex+1)+". Address: "+exploit.address+" Name: "+exploit.name+" Comment: "+exploit.comment)
    if (exploit.hasRequirement == true) then
      print("  Requirements: ")
      for r in exploit.requirements.indexes()
        print("    * "+exploit.requirements[r]+".")
      end for
    end if
  end for

  vulnIndex = user_input("Select Vuln to use: ").to_int()
  if (vulnIndex == 0) then
    scanForNewVuln = true
  else 
    exploitToUse = knownVulns[libSSH.version][vulnIndex-1]
  end if
else
  print("No known vulns, scanning...")
end if

if (exploitToUse == null) then
  exploits = ScanVulns(libSSH)
  for exploit in exploits

    if (scanForNewVuln) then
      foundSameVuln = false
      for exploitIndex in knownVulns[libSSH.version].indexes()
        existingExploit = knownVulns[libSSH.version][exploitIndex]
        if (existingExploit.address == exploit.address) then
          if (existingExploit.name == exploit.name) then
            foundSameVuln = true
            break
          end if
        end if
      end for

      if (foundSameVuln) then
        print("Skipping known exploit Address: "+exploit.address+" Name: "+exploit.name)
        continue
      end if
    end if

    if (exploit.hasRequirement == true) then
      print("Exploit has the following requirements: ")
      for r in exploit.requirements.indexes()
        print("  * "+exploit.requirements[r]+".")
      end for
      
      tryExploit = user_input("Try exploit? [N/y]: ")
      if (tryExploit != "y") then
        continue
      end if
    end if

    overflow = libSSH.overflow(exploit.address, exploit.name)
    if (typeof(overflow) != "computer") then
      print("Skipping non-computer exploit...")
      continue
    end if

    print("Found new exploit: "+exploit)
    exploitToUse = exploit
    break

  end for
end if

if (exploitToUse == null) then
  exit("No computer exploits found")
end if

overflow = libSSH.overflow(exploitToUse.address, exploitToUse.name)
if (overflow == null) then
  exit("Exploit doesn't exist? Why did we have an invalid exploit")
end if

if (typeof(overflow) != "computer") then
  exit("Exploit is not a computer? Why did we have an non-computer exploit")
end if

filePath = user_input("Enter file path to view: ")
file = overflow.File(filePath)
if (file == null) then
  exit("File at path "+filePath+" does not exist")
end if

if (file.is_folder()) then
  print("File is folder, printing out directory listing: ")
  directoryListing = ""
  for folderIndex in file.get_folders().indexes()
    folder = file.get_folders()[folderIndex]
    directoryListing += folder.permissions()+"  "+folder.owner()+"  "+folder.group()+"  "+folder.size()+" 00:00 "+folder.name()+"\n"
  end for
  for fileIndex in file.get_files().indexes()
    f = file.get_files()[fileIndex]
    directoryListing += f.permissions()+"  "+f.owner()+"  "+f.group()+"  "+f.size()+" 00:00 "+f.name()+"\n"
  end for
  print(format_columns(directoryListing))

else if (file.is_binary()) then
  print("File is binary, cant do anything with it")

else if (file.get_content() != null) then
  print("File content is bellow:")
  print(file.get_content())

else
  print("No access to the file")
end if

exit()
